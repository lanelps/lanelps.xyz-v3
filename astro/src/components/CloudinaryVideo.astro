---
import { generateCloudinaryVideoURL } from "@utils/cloudinary";

const { class: className, video: node, width } = Astro.props;
const preferredFormats = ["webm", "mp4"] as const;
const sources: { src: string; type: string }[] = [];

if (node?.public_id) {
  for (const format of preferredFormats) {
    try {
      const src = generateCloudinaryVideoURL(node.public_id, {
        width,
        format,
      });

      if (src) {
        sources.push({
          src,
          type: format === "mp4" ? "video/mp4" : `video/${format}`,
        });
      }
    } catch (error) {
      console.error(error);
    }
  }
}
---

{
  sources.length > 0 && (
    <>
      <video
        autoplay
        playsinline
        loop
        muted
        class:list={["relative h-full w-full object-cover", className]}
      >
        {sources.map(({ src, type }) => (
          <source src={src} type={type} />
        ))}
        Sorry, your browser doesn&#39;t support embedded videos.
      </video>
    </>
  )
}

<script>
  document.addEventListener("astro:page-load", () => {
    let videoElements = document.querySelectorAll("video");

    videoElements.forEach((vid) => {
      if (vid.autoplay) {
        vid.play();
      }
    });
  });
</script>
