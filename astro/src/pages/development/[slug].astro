---
import { sanityClient } from "sanity:client";

import Layout from "@layouts/Layout.astro";

import SanityImage from "@components/SanityImage.astro";
import MuxVideo from "@components/MuxVideo.svelte";
import ProjectInfo from "@components/ProjectInfo.astro";
import RichText from "@components/RichText.astro";

import { projectsQuery } from "@utils/queires";

import type { Project } from "../../types";

export async function getStaticPaths() {
  const projects: Project[] = await sanityClient.fetch(projectsQuery);

  return projects.map((project) => {
    return {
      params: { slug: project.slug.current },
      props: { project },
    };
  });
}

const {
  title,
  description,
  categories,
  collaborators,
  software,
  gallery,
  seo,
} = Astro.props.project;

const layoutClasses = {
  full: {
    wrapper: "col-span-full",
    content: "w-full h-full object-contain sm-t:object-cover",
  },
  center: {
    wrapper: "col-span-full sm-t:col-start-2 sm-t:col-span-3",
    content: "object-contain mt-[50%] -translate-y-1/2",
  },
  left: {
    wrapper: "col-span-full sm-t:col-span-4",
    content: "h-full object-contain",
  },
  right: {
    wrapper: "sm-t:col-start-2 col-span-full",
    content: "h-full object-contain",
  },
};

const pageSEO = {
  title: seo?.title || title,
  description: seo?.description,
  keywords: seo?.keywords,
  image: seo?.image?.url,
};
---

<Layout logoActive seo={pageSEO}>
  <ProjectInfo
    categories={categories}
    collaborators={collaborators}
    software={software}
  >
    <RichText value={description} />
  </ProjectInfo>

  <header
    id="project-header"
    class="mt-logo text-h1 relative z-50 mix-blend-difference"
  >
    <h1 class="text-grey-invert inline">{title}</h1>
    <a id="info-open" href="#info" class="text-dark-grey-invert">Info</a>
    <a id="info-close" href="##" class="text-dark-grey-invert hidden">Close</a>
  </header>

  <ul
    class="fixed inset-0 flex h-dvh w-dvw snap-y snap-mandatory flex-col overflow-y-scroll scroll-smooth"
  >
    {
      gallery.map((item) => {
        const wrapperClass = layoutClasses[item.layout].wrapper || "";
        const contentClass = layoutClasses[item.layout].content || "";

        return (
          <li class="grid-main relative h-full w-full shrink-0 snap-center snap-always overflow-hidden">
            {item.type === "image" && (
              <SanityImage
                image={item.image}
                class:list={["h-full max-h-dvh w-full", wrapperClass]}
                imgClass={contentClass}
              />
            )}
            {item.type === "video" && (
              <MuxVideo
                client:load
                video={item.video}
                class:list={["h-full max-h-dvh w-full", wrapperClass]}
                imgClass={contentClass}
              />
            )}
          </li>
        );
      })
    }
  </ul>
</Layout>
